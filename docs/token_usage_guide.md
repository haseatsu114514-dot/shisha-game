# トークン使用量削減ガイド（Claude Code / Claude API 共通）

> このプロジェクト（shisha-game）で Claude を使う際に、トークン消費を減らすための実践的なテクニック集です。

---

## 目次

1. [現状の把握](#1-現状の把握)
2. [CLAUDE.md を活用する](#2-claudemd-を活用する)
3. [プロンプトの最適化](#3-プロンプトの最適化)
4. [ファイル読み込みのスコープを絞る](#4-ファイル読み込みのスコープを絞る)
5. [データファイル（JSON）の扱い方](#5-データファイルjsonの扱い方)
6. [コードの重複を減らす](#6-コードの重複を減らす)
7. [会話の管理テクニック](#7-会話の管理テクニック)
8. [brand/ ディレクトリの整理](#8-brand-ディレクトリの整理)
9. [Claude Code 固有の設定](#9-claude-code-固有の設定)

---

## 1. 現状の把握

### プロジェクトのファイル規模（行数概算）

| カテゴリ | 行数合計 | 主な大規模ファイル |
|---|---|---|
| `brand/*.md` | ~2,200行 | `story_and_structure.md`(892行), `gameplay_feedback.md`(422行) |
| `data/**/*.json` | ~7,000行 | `ch1_main.json`(936行), `ch1_tournament.json`(707行) |
| `scripts/**/*.gd` | ~22,000行 | `ch1_tournament.gd`(4,261行), `ch2-4_tournament.gd`(各~3,000行) |
| `docs/*.md` | ~130行 | キャラクターアイデア系 |

**1行 ≈ 3〜5トークン** と仮定すると、全ファイルを読み込むだけで **10万トークン以上** を消費する可能性があります。

---

## 2. CLAUDE.md を活用する

プロジェクトルートに `CLAUDE.md` を置くと、Claude Code が会話開始時に自動で読み込みます。ここにプロジェクトの「最小限の要約」を書いておくことで、毎回資料全文を読ませる必要がなくなります。

### 推奨する CLAUDE.md の構成（例）

```markdown
# shisha-game

Godot 4 製シーシャ屋アドベンチャー＆シミュレーションゲーム。

## ディレクトリ構成
- scripts/autoload/ — グローバルマネージャー (GameManager, PlayerData 等)
- scripts/daily/ — 日常パート (練習, バイト, マップ移動 等)
- scripts/tournament/ — 大会パート (ch1〜ch4)
- scripts/ui/ — UI コンポーネント
- data/ — ゲームデータ (JSON)
- data/dialogue/ — 会話データ (ch1_main.json 等)
- brand/ — 世界観・キャラクター設定資料

## 主人公のテーマ
「素直さ」＝他人の良さに素直に気づける力。それは嫉妬にもなるが、吸収と継承の源でもある。旧設定の「客観視」「フラットさ」は廃止済み。

## 技術スタック
- Godot 4 (GDScript)
- データ駆動: JSON でキャラ・会話・イベントを管理

## よく使うコマンド
- python3 tools/dialogue_editor.py — 会話データ編集
```

> **効果**: 毎回 `brand/story_and_structure.md` (892行) を丸ごと読ませなくても、CLAUDE.md の 20〜30行でプロジェクトの全体像を伝えられる。

---

## 3. プロンプトの最適化

### 3-A. 1回の依頼を小さく分割する

**悪い例（トークン大量消費）:**
> 全キャラクターの設定を読んで、全員分の裏設定と成長ステータスとビジュアルコンセプトを書いて、JSONに反映して

**良い例（分割して依頼）:**
> 1回目: 「アダムの設定を `brand/character_profiles.md` の該当部分だけ読んで、裏設定を考えて」
> 2回目: 「その結果を `data/characters.json` のアダムの項目に反映して」

### 3-B. 読むべきファイルを明示する

**悪い例:**
> プロジェクトの設定を読んで修正して

**良い例:**
> `brand/character_profiles.md` の「みんと」の項（70〜90行目あたり）を読んで修正して

### 3-C. 既に共有した情報は繰り返さない

同じ会話の中で一度読んだファイルは、Claude のコンテキストに残っています。再度読ませる必要はありません。

---

## 4. ファイル読み込みのスコープを絞る

### 行範囲を指定して読む

Claude Code の Read ツールは `offset` と `limit` で行範囲を指定できます。

```
# 全部読む（892行 → 約3,000トークン消費）
brand/story_and_structure.md

# 第1章だけ読む（例: 1〜100行 → 約350トークン）
brand/story_and_structure.md の 1〜100行
```

### 必要なファイルだけ指定する

会話データを修正するとき、全章の dialogue を読む必要はありません:

```
# 悪い例: 「data/dialogue/ の全ファイルを確認して」
# 良い例: 「data/dialogue/ch1_minto.json を開いて、みんとの口調を確認して」
```

---

## 5. データファイル（JSON）の扱い方

### 5-A. 部分的な編集指示

JSONファイル全体を出力させると大量のトークンを消費します。

**悪い例:**
> `characters.json` を全体書き直して

**良い例:**
> `characters.json` の `"id": "adam"` の項目に `"background_secret"` フィールドを追加して。値は「〇〇」

### 5-B. jq を活用する

特定フィールドだけ見たい場合:

```bash
# キャラクター名の一覧だけ取得（全265行を読む必要なし）
jq '.[].name' data/characters.json

# アダムの項目だけ抽出
jq '.[] | select(.id == "adam")' data/characters.json
```

---

## 6. コードの重複を減らす

### 大会スクリプトの共通化（最大のトークン削減ポイント）

現在 `scripts/tournament/` に ch1〜ch4 の大会スクリプトが個別に存在し、合計 **約13,300行** あります:

| ファイル | 行数 |
|---|---|
| `ch1_tournament.gd` | 4,261 |
| `ch2_tournament.gd` | 3,015 |
| `ch3_tournament.gd` | 3,015 |
| `ch4_tournament.gd` | 3,028 |

ch2〜ch4 はほぼ同じ構造と推測されます。共通ロジックを基底クラスに抽出し、章固有の部分だけオーバーライドする設計にすると:

- **コード量**: 13,300行 → 推定5,000行以下
- **Claude に読ませる量**: 大会ロジックの修正時に1ファイルだけ読めば済む
- **バグ修正**: 1箇所直せば全章に反映

```
# リファクタリング案
scripts/tournament/
  base_tournament.gd      # 共通ロジック（新規）
  ch1_tournament.gd       # 章固有の差分のみ
  ch2_tournament.gd       # ↑同様
  ...
```

---

## 7. 会話の管理テクニック

### 7-A. 長い会話は新しいセッションで

Claude Code の会話が長くなると、過去のやり取り全体がコンテキストとして送られます。トピックが変わったら `/clear` や新セッションで仕切り直すのが効果的です。

### 7-B. 作業カテゴリで会話を分ける

| 会話 | 担当範囲 |
|---|---|
| セッション1 | シナリオ・設定の添削（brand/ のみ） |
| セッション2 | JSONデータの更新（data/ のみ） |
| セッション3 | GDScript の実装（scripts/ のみ） |

こうすると、各会話で必要なコンテキストが最小限になります。

### 7-C. 結果を都度ファイルに保存する

Claude に出力させた内容は毎回ファイルに書き込んでもらいましょう。次の会話ではそのファイルだけ読めば、前回の議論を再現する必要がありません。

---

## 8. brand/ ディレクトリの整理

現在 `brand/` に複数のプロンプトテンプレートが存在します:

| ファイル | 行数 | 内容 |
|---|---|---|
| `claude_code_prompt.md` | 91 | Claude Code 向け作業プロンプト |
| `claude_prompt_template.md` | 35 | ストーリーブラッシュアップ依頼 |
| `claude_prompt_comprehensive.md` | 37 | 統合指示プロンプト |

これらは内容が重複しているため、**1つに統合する**とトークン節約になります:

```
# 統合案
brand/claude_prompt.md          # 統合版（旧3ファイルを1つに）
brand/character_profiles.md     # そのまま
brand/story_and_structure.md    # そのまま
```

また、`comprehensive_feedback.md`(222行) と `gameplay_feedback.md`(422行) は過去のフィードバック記録です。作業中に毎回読む必要がなければ `brand/archive/` に移動して、Claude の自動読み込み対象から外すことを検討してください。

---

## 9. Claude Code 固有の設定

### 9-A. .claudeignore

`.claudeignore` ファイルを作成すると、Claude Code がインデックスに含めないファイルを指定できます。`.gitignore` と同じ書式です。

```
# .claudeignore の例
.godot/
assets/IMAGE_ASSET_REPORT.md
brand/archive/
*.import
*.translation
アセット差し替え進捗管理表.*
```

### 9-B. 依頼時のテンプレート

毎回のプロンプトに以下のテンプレートを使うと、不要なファイル読み込みを防げます:

```
【対象ファイル】: （編集するファイルパス）
【参考ファイル】: （読む必要があるファイルパス、行範囲）
【やること】: （具体的な作業内容）
【出力先】: （結果を保存するファイルパス）
```

---

## まとめ：効果の大きい施策 TOP 5

| 順位 | 施策 | 推定削減効果 |
|---|---|---|
| 1 | CLAUDE.md の作成 | 毎回の初期読み込みを ~800行 → ~30行 に |
| 2 | 大会スクリプトの共通化 | コード修正時の読み込みを ~13,000行 → ~5,000行 に |
| 3 | 依頼を小さく分割する | 1回あたりの入出力トークンを 50%以上 削減 |
| 4 | brand/ のプロンプト統合 | 重複する ~160行分 を削除 |
| 5 | .claudeignore の設定 | 不要ファイルのインデックスを除外 |
